(()=>{"use strict";(()=>{const e=Object.freeze({x:25,y:50}),t=Object.freeze({min:30,max:100});window.constants={XY_OFFSET:e,FORM_TITLE_LENGTH:t,PRICE_BY_HOUSE_TYPE:{bungalow:{min:0,max:1e6},flat:{min:1e3,max:1e6},house:{min:5e3,max:1e6},palace:{min:1e4,max:1e6}},OFFER_TYPE_VALUE:{palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},HIGHT_MAINPIN_TAIL:15,PINS_NUMBER:5}})(),window.debounce=e=>{let t=null;return()=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e.spread(null,"arguments")}),500)}},window.load={downloadData:(e,t)=>{const o=new XMLHttpRequest;o.responseType="json",o.addEventListener("load",(()=>{200===o.status?e(o.response):t("Статус ответа: "+o.status+" "+o.statusText)})),o.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),o.addEventListener("timeout",(()=>{t("Запрос не успел выполниться за "+o.timeout+" мс")})),o.timeout=1e4,o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.send()},uploadData:(e,t,o)=>{const n=new XMLHttpRequest;n.responseType="json",n.addEventListener("load",(()=>{200===n.status?window.dialog.onSuccessUploadDialog():window.dialog.onErrorUploadDialog()})),n.addEventListener("error",(()=>{o("Произошла ошибка соединения")})),n.addEventListener("timeout",(()=>{o("Запрос не успел выполниться за "+n.timeout+" мс")})),n.timeout=1e4,n.open("POST","https://21.javascript.pages.academy/keksobooking"),n.send(e)}},(()=>{const e=1e4,t=5e4,o=0,n=1e4,r=5e4,a=1/0,i=document.querySelector(".map__filters"),s=i.querySelector("#housing-type"),d=i.querySelector("#housing-price"),c=i.querySelector("#housing-rooms"),l=i.querySelector("#housing-guests"),u=Array.from(i.querySelectorAll(".map__checkbox")),p=i=>{let s=null;return i.offer.price>=e&&i.offer.price<=t&&(s="middle"),i.offer.price>=o&&i.offer.price<=n&&(s="low"),i.offer.price>=r&&i.offer.price<a&&(s="high"),s===d.value},m=e=>e.offer.guests.toString()===l.value,f=e=>{const t=u.filter((e=>e.checked));if(t.length>0){const o=e.offer.features;return t.every((e=>-1!==o.indexOf(e.value)))}return!0};i.addEventListener("change",(()=>{window.popup.removeCard(),window.debounce(window.pin.renderPins((e=>{let t=[];for(let o=0;o<e.length;o++){let n=!0;if("any"!==s.value&&(n=e[o].offer.type===s.value),!1!==n&&("any"===d.value||(n=p(e[o]),!1!==n))&&("any"===c.value||(n=e[o].offer.rooms.toString()===c.value,!1!==n))&&("any"===l.value||(n=m(e[o]),!1!==n))&&(n=f(e[o]),!1!==n&&(t.push(e[o]),t.length>=window.constants.PINS_NUMBER)))break}return t})(window.array)))})),window.filters={resetFilters:()=>i.reset()}})(),(()=>{const e=document.querySelector("main");window.dialog={onErrorDownloadDialog:e=>{const t=document.createElement("div");t.style.zIndex=100,t.style.margin="0 auto",t.style.textAlign="center",t.style.backgroundColor="red",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},onSuccessUploadDialog:()=>{const t=document.querySelector("#success").content.cloneNode(!0);e.insertBefore(t,window.map.mapBlock);const o=e.querySelector(".success"),n=e.querySelector(".success__message"),r=e=>{e.target!==o&&e.target!==n||(o.remove(),o.removeEventListener("click",r),document.removeEventListener("keydown",a))},a=e=>{"Escape"===e.key&&(e.preventDefault(),o.remove(),o.removeEventListener("click",r),document.removeEventListener("keydown",a))};o.addEventListener("click",r),document.addEventListener("keydown",a),window.form.resetAdForm()},onErrorUploadDialog:()=>{const t=document.querySelector("#error").content.cloneNode(!0);e.insertBefore(t,window.map.mapBlock);const o=e.querySelector(".error"),n=e.querySelector(".error__message"),r=e.querySelector(".error__button"),a=e=>{e.target!==o&&e.target!==n&&e.target!==r||(o.remove(),o.removeEventListener("click",a),document.removeEventListener("keydown",i))},i=e=>{"Escape"===e.key&&(e.preventDefault(),o.remove(),o.removeEventListener("click",a),document.removeEventListener("keydown",i))};o.addEventListener("click",a),document.addEventListener("keydown",i)}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pin--main"),o=t.querySelector("img"),n={width:Math.floor(t.offsetWidth/2),height:Math.floor((t.offsetHeight+window.constants.HIGHT_MAINPIN_TAIL)/2)},r=Math.round((t.offsetWidth-o.offsetWidth)/2);window.map={mapBlock:e,mapPinMain:t,halfMainPin:n,shiftRightPinImg:r}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pins"),o=t=>{const o=document.querySelector("#pin").content.cloneNode(!0),n=o.querySelector("img"),r=o.querySelector("button");return r.style.left=t.location.x-window.constants.XY_OFFSET.x+"px",r.style.top=t.location.y-window.constants.XY_OFFSET.y+"px",n.src=""+t.author.avatar,n.alt=""+t.offer.title,r.addEventListener("click",(()=>{const o=e.querySelector(".map__card"),n=e.querySelector(".map__pin--active");n&&n.classList.remove("map__pin--active"),o&&o.remove(),window.popup.createOfferCard(t),r.classList.add("map__pin--active")})),o};window.pin={renderPins:n=>{e.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}));const r=document.createDocumentFragment();let a=n.length>window.constants.PINS_NUMBER?window.constants.PINS_NUMBER:n.length;for(let e=0;e<a;e++)r.appendChild(o(n[e]));t.appendChild(r)}}})(),(()=>{const e=Object.freeze({x1:0,x2:1200,y1:130,y2:630}),t=window.map.mapBlock,o=window.map.mapPinMain,n=window.map.halfMainPin.width,r=window.map.halfMainPin.height;o.addEventListener("mousedown",(a=>{a.preventDefault();let i={x:a.clientX,y:a.clientY};const s=a=>{a.preventDefault();const s=i.x-a.clientX,d=i.y-a.clientY;i={x:a.clientX,y:a.clientY};const c=o.offsetLeft+n-s;o.style.left=o.offsetLeft-s+"px",c<0&&(o.style.left=0-n+"px"),c>t.clientWidth&&(o.style.left=t.clientWidth-n+"px");const l=o.offsetTop+r-d;l<e.y1?o.style.top=e.y1-r+"px":l>e.y2?o.style.top=e.y2-r+"px":o.style.top=o.offsetTop-d+"px";const u=o.offsetLeft+window.map.halfMainPin.width,p=o.offsetTop+window.map.halfMainPin.height;window.form.adFormAddressField.value=`${u}, ${p}`,window.popup.removeCard()},d=e=>{e.preventDefault(),document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",d)};document.addEventListener("mousemove",s),document.addEventListener("mouseup",d)}))})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pins"),o=e=>{"Escape"===e.key&&n()},n=()=>{const t=e.querySelector(".map__card");t.remove();const r=e.querySelector(".map__pin--active");r&&r.classList.remove("map__pin--active"),t.querySelector(".popup__close").removeEventListener("click",n),document.removeEventListener("keydown",o)};window.popup={createOfferCard:e=>{const r=document.querySelector("#card").content.querySelector(".map__card").cloneNode(!0),a=r.querySelector(".popup__title"),i=r.querySelector(".popup__text--address"),s=r.querySelector(".popup__text--price"),d=r.querySelector(".popup__type"),c=r.querySelector(".popup__text--capacity"),l=r.querySelector(".popup__text--time"),u=r.querySelector(".popup__description"),p=r.querySelector(".popup__avatar");a.textContent=e.offer.title,i.textContent=e.offer.address,s.textContent=e.offer.price+" ₽/ночь",d.textContent=window.constants.OFFER_TYPE_VALUE[e.offer.type],c.textContent=`${e.offer.rooms} комнаты для ${e.offer.guests} гостей.`,l.textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}.`,((e,t)=>{const o=e.querySelector(".popup__features");o.innerHTML="",t&&0!==t.length||o.classList.add("hidden");const n=document.createDocumentFragment();t.forEach((e=>{const t=document.createElement("li");t.classList.add("popup__feature","popup__feature--"+e),n.appendChild(t)})),o.appendChild(n)})(r,e.offer.features),u.textContent=e.offer.description,((e,t)=>{const o=e.querySelector(".popup__photos"),n=o.querySelector("img");o.innerHTML="",t&&0!==t.length||o.classList.add("hidden");const r=document.createDocumentFragment();t.forEach((e=>{const t=n.cloneNode();t.src=e,r.appendChild(t)})),o.appendChild(r)})(r,e.offer.photos),p.src=""+e.author.avatar,t.append(r),r.querySelector(".popup__close").addEventListener("click",n),document.addEventListener("keydown",o)},removeCard:()=>{e.querySelector(".map__card")&&n()}}})(),(()=>{const e=window.dialog.onSuccessUploadDialog,t=window.dialog.onErrorUploadDialog,o=document.querySelector(".ad-form"),n=o.querySelector("#title"),r=o.querySelector("#address"),a=o.querySelector("#type"),i=o.querySelector("#price"),s=o.querySelector("#timein"),d=o.querySelector("#timeout"),c=o.querySelector("#capacity"),l=o.querySelector("#room_number"),u=document.querySelector(".map__pin--main"),p=(e,t)=>(e=window.constants.PRICE_BY_HOUSE_TYPE[a.value].min,t=window.constants.PRICE_BY_HOUSE_TYPE[a.value].max,i.placeholder=e,i.min=e,i.max=t,{min:e,max:t});i.min=p().min;const m=e=>{const t=Number(c.value),o=Number(l.value);e.setCustomValidity(""),0!==t&&100===o&&e.setCustomValidity("Не для гостей. Пожалуйста, выберите другой вариант."),0===t&&100!==o&&e.setCustomValidity("Для выбора (не для гостей). Пожалуйста, выберите максимальное количество комнат."),t>o&&e.setCustomValidity("Слишком много гостей для данного выбора комнат. Пожалуйста, выберите больше комнат.")};n.addEventListener("input",(()=>{(()=>{const e=n.value;e.length>=window.constants.FORM_TITLE_LENGTH.min&&e.length<=window.constants.FORM_TITLE_LENGTH.max?n.setCustomValidity(""):0===e.length?n.setCustomValidity("Пожалуйста, заполните это поле"):n.setCustomValidity(`должно быть от ${window.constants.FORM_TITLE_LENGTH.min} до ${window.constants.FORM_TITLE_LENGTH.max} символов`)})()})),a.addEventListener("input",(()=>{p()})),i.addEventListener("input",(()=>{((e,t)=>{e=p().min,t=p().max;const o=i.value;o>=e&&o<=t?i.setCustomValidity(""):0===o.length?i.setCustomValidity(`введите значение от ${e} до ${t}`):o>t?i.setCustomValidity(`Цена данной тип жилья максимум до ${t} руб.`):i.setCustomValidity(`введите значение от ${e} до ${t}`)})()})),s.addEventListener("change",(()=>{d.value=s.value})),d.addEventListener("change",(()=>{s.value=d.value})),c.addEventListener("change",(()=>{m(c)})),l.addEventListener("change",(()=>{m(c)})),o.addEventListener("submit",(n=>{n.preventDefault(),window.load.uploadData(new FormData(o),e,t)}));const f=()=>{o.reset(),window.filters.resetFilters(),window.main.deactivateBookingPage()};o.addEventListener("reset",f),window.form={setAddressField:()=>{const e=u.offsetLeft+window.map.halfMainPin.width-window.map.shiftRightPinImg,t=u.offsetTop+window.map.halfMainPin.height;r.value=`${e}, ${t}`},adFormAddressField:r,resetAdForm:f}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pin--main"),o=document.querySelector(".map__filters"),n=o.querySelectorAll("select"),r=o.querySelectorAll("input"),a=document.querySelector(".ad-form"),i=a.querySelectorAll("fieldset"),s=t.offsetLeft,d=t.offsetTop;window.array=[];const c=e=>{let t=[];e.forEach((e=>{t.push(e)})),window.pin.renderPins(t),window.array=t},l=window.dialog.onErrorDownloadDialog,u=()=>{window.load.downloadData(c,l),e.classList.remove("map--faded"),a.classList.remove("ad-form--disabled"),n.forEach((e=>{e.disabled=!1})),r.forEach((e=>{e.disabled=!1})),i.forEach((e=>{e.disabled=!1})),t.removeEventListener("mousedown",m),t.removeEventListener("keydown",f),window.form.setAddressField()},p=()=>{const o=e.querySelectorAll(".map__pin:not(.map__pin--main)");e.classList.add("map--faded"),a.classList.add("ad-form--disabled"),n.forEach((e=>{e.disabled=!0})),r.forEach((e=>{e.disabled=!0})),i.forEach((e=>{e.disabled=!0})),o.forEach((e=>{e.remove()})),window.popup.removeCard(),t.style.left=s+"px",t.style.top=d+"px",t.addEventListener("mousedown",m),t.addEventListener("keydown",f)},m=t=>{0===t.button&&e.classList.contains("map--faded")&&u()},f=t=>{"Enter"===t.key&&e.classList.contains("map--faded")&&u()};p(),window.main={onSuccessDownloadData:c,deactivateBookingPage:p}})()})();